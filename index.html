<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mindpeel</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§ </text></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ icons (inline SVG components) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const Icons = {
  layers: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||20} height={p?.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...p}>
      <path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.84Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/>
    </svg>
  ),
  wind: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||20} height={p?.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...p}>
      <path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/>
    </svg>
  ),
  arrowDown: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||16} height={p?.size||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}>
      <path d="M12 5v14"/><path d="m19 12-7 7-7-7"/>
    </svg>
  ),
  download: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||16} height={p?.size||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}>
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
    </svg>
  ),
  copy: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||16} height={p?.size||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}>
      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
    </svg>
  ),
  refresh: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||16} height={p?.size||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}>
      <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/>
    </svg>
  ),
  play: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||20} height={p?.size||20} viewBox="0 0 24 24" fill="currentColor" stroke="none" {...p}>
      <polygon points="6,3 20,12 6,21"/>
    </svg>
  ),
  pause: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||20} height={p?.size||20} viewBox="0 0 24 24" fill="currentColor" stroke="none" {...p}>
      <rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/>
    </svg>
  ),
  check: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||16} height={p?.size||16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...p}>
      <polyline points="20 6 9 17 4 12"/>
    </svg>
  ),
  sparkle: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||14} height={p?.size||14} viewBox="0 0 24 24" fill="currentColor" stroke="none" {...p}>
      <path d="M12 2l2.4 7.2L22 12l-7.6 2.8L12 22l-2.4-7.2L2 12l7.6-2.8z"/>
    </svg>
  ),
  party: (p) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={p?.size||20} height={p?.size||20} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" {...p}>
      <path d="M5.8 11.3 2 22l10.7-3.79"/><path d="M4 3h.01"/><path d="M22 8h.01"/><path d="M15 2h.01"/><path d="M22 20h.01"/><path d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10"/><path d="m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11c-.11.7-.72 1.22-1.43 1.22H17"/><path d="m11 2 .33.82c.34.86-.2 1.82-1.11 1.98C9.52 4.9 9 5.52 9 6.23V7"/>
    </svg>
  ),
};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ prompt per layer â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const layerPrompts = [
  "What's weighing on you right now?",
  "Why?",
  "Why is that?",
  "And why does that matter?",
  "What's really at the root of this?",
  "Now that you can see the thread â€” what do you want to do with it?",
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Step component â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Step({ index, prompt, answer, active, done, onSubmit, onChange, total, prevAnswer }) {
  const ref = useRef(null);
  useEffect(() => {
    if (active && ref.current) {
      ref.current.focus();
      ref.current.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }, [active]);

  const filled = !active && answer;
  const visible = active || filled;

  return (
    <div className={`transition-all duration-700 ease-out ${visible ? "opacity-100 translate-y-0" : "opacity-0 translate-y-4 h-0 overflow-hidden pointer-events-none"}`}>
      {index > 0 && visible && (
        <div className="flex flex-col items-center my-3 gap-1">
          <div className="w-px h-6 bg-gradient-to-b from-amber-200 to-amber-300 rounded-full" />
          <Icons.arrowDown size={14} className="text-amber-400" />
        </div>
      )}
      <div className={`rounded-2xl border transition-all duration-300 ${active ? "bg-white border-amber-200 shadow-lg shadow-amber-100/50" : "bg-white/60 border-stone-200/60"} p-5`}>
        <div className="flex items-center gap-2 mb-2">
          <span className={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${active ? "bg-amber-100 text-amber-700" : filled ? "bg-stone-100 text-stone-400" : "bg-stone-100 text-stone-400"}`}>
            {filled && !active ? <Icons.check size={12} /> : index + 1}
          </span>
          <span className="text-xs font-medium tracking-wide uppercase text-stone-400">
            {index === 0 ? "Surface" : index <= 3 ? "Layer " + index : index === 4 ? "Root" : "Reflect"}
          </span>
        </div>
        {prevAnswer && (
          <div className="mb-3 pl-3 border-l-2 border-amber-200 bg-amber-50/50 rounded-r-lg py-2 pr-3">
            <p className="text-xs text-stone-400 italic leading-relaxed">"{prevAnswer}"</p>
          </div>
        )}
        <p className={`text-sm mb-3 leading-relaxed ${active ? "text-stone-600" : "text-stone-400"}`}>{prompt}</p>
        {active ? (
          <form onSubmit={(e) => { e.preventDefault(); if (answer?.trim()) onSubmit(); }}>
            <textarea ref={ref} value={answer || ""} onChange={(e) => onChange(e.target.value)}
              onKeyDown={(e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); if (answer?.trim()) onSubmit(); } }}
              rows={3} placeholder="Be honest with yourselfâ€¦"
              className="w-full bg-stone-50/80 border border-stone-200 rounded-xl px-4 py-3 text-stone-800 text-sm leading-relaxed resize-none focus:outline-none focus:ring-2 focus:ring-amber-200 focus:border-transparent placeholder:text-stone-300 transition-all"
            />
            <div className="flex items-center justify-between mt-3">
              <span className="text-xs text-stone-300">Shift+Enter for new line</span>
              <button type="submit" disabled={!answer?.trim()} className="flex items-center gap-2 text-sm px-5 py-2 rounded-full bg-stone-800 text-white disabled:opacity-20 hover:bg-stone-700 active:scale-95 transition-all">
                {index < total - 1 ? "Go deeper" : "Finish"}
                {index < total - 1 ? <Icons.arrowDown size={13} /> : <Icons.sparkle size={12} />}
              </button>
            </div>
          </form>
        ) : (
          <p className="text-stone-700 text-sm leading-relaxed">{answer}</p>
        )}
      </div>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Take 5 activities â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const activities = [
  { emoji: "ðŸ«", title: "Box Breathing", desc: "Breathe in 4s, hold 4s, out 4s, hold 4s. Repeat.", type: "breathe" },
  { emoji: "ðŸ‘€", title: "5-4-3-2-1 Grounding", desc: "Name 5 things you see, 4 you hear, 3 you touch, 2 you smell, 1 you taste.", type: "grounding" },
  { emoji: "ðŸš¶", title: "Walk Away", desc: "Get up. Walk for 5 minutes. No phone. Just notice what's around you.", type: "minitimer", timerSec: 300 },
  { emoji: "ðŸŽµ", title: "One Song Reset", desc: "Put on a song you love. Close your eyes. Just listen.", type: "link", url: "https://open.spotify.com", linkLabel: "Open Spotify" },
  { emoji: "ðŸ’§", title: "Cold Water", desc: "Splash cold water on your face or hold something cold. Reset your nervous system.", type: "tip", tip: "Go now. Come back when you're done. We'll be here." },
  { emoji: "âœï¸", title: "Brain Dump", desc: "Write everything in your head. Don't organize, just dump.", type: "braindump" },
  { emoji: "ðŸŒ³", title: "Look Outside", desc: "Find a window or step outside. Look at something far away for a full minute.", type: "minitimer", timerSec: 60 },
  { emoji: "ðŸ¤¸", title: "Shake It Off", desc: "Stand up and literally shake your hands, arms, legs for 30 seconds. Sounds silly. Works.", type: "minitimer", timerSec: 30 },
  { emoji: "ðŸ§Š", title: "Body Scan", desc: "Close your eyes. Starting from your toes, notice each body part and consciously relax it.", type: "bodyscan" },
  { emoji: "ðŸ™", title: "Gratitude Burst", desc: "Name 3 things you're grateful for right now. Be specific. Feel each one.", type: "gratitude" },
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Mini timer â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function MiniTimer({ seconds: initial }) {
  const [sec, setSec] = useState(initial);
  const [on, setOn] = useState(false);
  const ref = useRef(null);
  useEffect(() => { if (on && sec > 0) { ref.current = setInterval(() => setSec(s => s - 1), 1000); } else { clearInterval(ref.current); } return () => clearInterval(ref.current); }, [on, sec]);
  useEffect(() => { if (sec === 0) setOn(false); }, [sec]);
  const m = Math.floor(sec / 60), s = sec % 60;
  return (
    <div className="flex items-center gap-3 mt-2">
      <span className="text-lg font-light text-emerald-700 tabular-nums">{m}:{String(s).padStart(2, "0")}</span>
      <button onClick={() => setOn(!on)} className="px-3 py-1 rounded-full bg-emerald-600 text-white text-xs hover:bg-emerald-700 active:scale-95 transition-all">
        {sec === 0 ? "Done!" : on ? "Pause" : sec < initial ? "Resume" : "Start"}
      </button>
      {sec < initial && sec > 0 && <button onClick={() => { setOn(false); setSec(initial); }} className="text-xs text-stone-400 hover:text-stone-600">Reset</button>}
      {sec === 0 && <span className="text-xs text-emerald-600">Nice one.</span>}
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Copy button â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function CopyButton({ getText }) {
  const [copied, setCopied] = useState(false);
  const handleCopy = () => { const text = getText(); if (!text) return; navigator.clipboard.writeText(text); setCopied(true); setTimeout(() => setCopied(false), 2000); };
  return (
    <button onClick={handleCopy} className="flex items-center gap-1 text-xs text-stone-400 hover:text-stone-600 transition-colors">
      {copied ? <><Icons.check size={11} className="text-emerald-500" /> Copied</> : <><Icons.copy size={11} /> Copy</>}
    </button>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Grounding exercise â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function GroundingExercise() {
  const senses = [{ count: 5, sense: "see", emoji: "ðŸ‘" },{ count: 4, sense: "hear", emoji: "ðŸ‘‚" },{ count: 3, sense: "touch", emoji: "âœ‹" },{ count: 2, sense: "smell", emoji: "ðŸ‘ƒ" },{ count: 1, sense: "taste", emoji: "ðŸ‘…" }];
  const [values, setValues] = useState({});
  const setValue = (key, val) => setValues(p => ({ ...p, [key]: val }));
  const total = 15;
  const filled = Object.values(values).filter(v => v?.trim()).length;
  const getText = () => { if (filled === 0) return ""; return senses.map(({ count, sense }) => `${sense.toUpperCase()}:\n` + Array.from({ length: count }).map((_, j) => `  - ${values[`${sense}-${j}`] || "(empty)"}`).join("\n")).join("\n"); };
  return (
    <div className="mt-2 space-y-3">
      {senses.map(({ count, sense, emoji }) => (
        <div key={sense}>
          <p className="text-xs font-medium text-stone-500 mb-1">{emoji} {count} thing{count > 1 ? "s" : ""} you {sense}</p>
          <div className="space-y-1">
            {Array.from({ length: count }).map((_, j) => {
              const key = `${sense}-${j}`;
              return <input key={key} value={values[key] || ""} onChange={e => setValue(key, e.target.value)} placeholder={`I ${sense}â€¦`} className="w-full bg-white border border-stone-200 rounded-lg px-3 py-1.5 text-xs text-stone-700 focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-transparent placeholder:text-stone-300" />;
            })}
          </div>
        </div>
      ))}
      <div className="flex items-center justify-between pt-1">
        {filled === total ? <p className="text-xs text-emerald-600">All senses grounded. You're here.</p> : <p className="text-xs text-stone-400">{filled}/{total}</p>}
        {filled > 0 && <CopyButton getText={getText} />}
      </div>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Brain dump â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function BrainDump() {
  const [text, setText] = useState("");
  return (
    <div className="mt-2">
      <textarea value={text} onChange={e => setText(e.target.value)} rows={4} placeholder="Just let it all out. No one's reading thisâ€¦" className="w-full bg-white border border-stone-200 rounded-lg px-3 py-2 text-xs text-stone-700 resize-none focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-transparent placeholder:text-stone-300" />
      {text.length > 0 && (
        <div className="flex items-center justify-between mt-1.5">
          <span className="text-xs text-stone-400">{text.split(/\s+/).filter(Boolean).length} words out of your head</span>
          <div className="flex items-center gap-3"><CopyButton getText={() => text} /><button onClick={() => setText("")} className="text-xs text-stone-400 hover:text-stone-600">Clear</button></div>
        </div>
      )}
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Body scan (auto-advancing) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function BodyScanGuide() {
  const parts = [
    { name: "Toes & feet", cue: "Wiggle your toes. Notice the ground beneath you." },
    { name: "Legs", cue: "Feel the weight of your legs. Let them be heavy." },
    { name: "Hips & lower back", cue: "Soften here. Release any clenching." },
    { name: "Stomach & chest", cue: "Breathe deep. Feel your belly expand." },
    { name: "Hands & arms", cue: "Unclench your fists. Let your fingers go soft." },
    { name: "Shoulders & neck", cue: "Drop your shoulders away from your ears." },
    { name: "Face & head", cue: "Relax your jaw. Smooth your forehead." },
  ];
  const SEC_PER_PART = 15;
  const [current, setCurrent] = useState(-1);
  const [running, setRunning] = useState(false);
  const [tick, setTick] = useState(0);
  const intervalRef = useRef(null);

  useEffect(() => {
    if (running) {
      intervalRef.current = setInterval(() => {
        setTick(t => {
          if (t + 1 >= SEC_PER_PART) { setCurrent(c => { if (c + 1 >= parts.length) { setRunning(false); return parts.length; } return c + 1; }); return 0; }
          return t + 1;
        });
      }, 1000);
    } else { clearInterval(intervalRef.current); }
    return () => clearInterval(intervalRef.current);
  }, [running]);

  const start = () => { setCurrent(0); setTick(0); setRunning(true); };
  const isDone = current >= parts.length;
  const progress = current >= 0 && !isDone ? ((current * SEC_PER_PART + tick) / (parts.length * SEC_PER_PART)) * 100 : isDone ? 100 : 0;

  return (
    <div className="mt-2">
      {current === -1 ? (
        <div>
          <p className="text-xs text-stone-400 mb-2">Auto-advances every {SEC_PER_PART}s. Close your eyes and listen to your body.</p>
          <button onClick={start} className="px-3 py-1.5 rounded-full bg-emerald-600 text-white text-xs hover:bg-emerald-700 active:scale-95 transition-all">Begin scan</button>
        </div>
      ) : !isDone ? (
        <div>
          <p className="text-sm font-medium text-emerald-700 mb-0.5">{parts[current].name}</p>
          <p className="text-xs text-stone-500 mb-2 italic">{parts[current].cue}</p>
          <div className="flex items-center gap-2 mb-2">
            <div className="flex-1 h-1 bg-stone-200 rounded-full overflow-hidden"><div className="h-full bg-emerald-400 rounded-full transition-all duration-1000 ease-linear" style={{ width: `${progress}%` }} /></div>
            <span className="text-xs text-stone-400 tabular-nums w-8 text-right">{SEC_PER_PART - tick}s</span>
          </div>
          <div className="flex gap-2">
            <button onClick={() => setRunning(!running)} className="px-3 py-1 rounded-full bg-emerald-600 text-white text-xs hover:bg-emerald-700 active:scale-95 transition-all">{running ? "Pause" : "Resume"}</button>
            <button onClick={() => { setCurrent(c => Math.min(c + 1, parts.length)); setTick(0); }} className="px-3 py-1 rounded-full border border-stone-200 text-stone-500 text-xs hover:bg-stone-50 transition-all">Skip â†’</button>
          </div>
        </div>
      ) : (
        <p className="text-xs text-emerald-600">Full body scanned. Take a moment to notice how you feel.</p>
      )}
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Gratitude exercise â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function GratitudeExercise() {
  const [items, setItems] = useState(["", "", ""]);
  const filled = items.filter(i => i.trim()).length;
  const getText = () => { const f = items.filter(i => i.trim()); if (!f.length) return ""; return "Grateful for:\n" + f.map((item, i) => `${i + 1}. ${item}`).join("\n"); };
  return (
    <div className="mt-2 space-y-2">
      {items.map((val, i) => (
        <div key={i} className="flex items-center gap-2">
          <span className="text-xs text-stone-400 w-4 flex-shrink-0">{i + 1}.</span>
          <input value={val} onChange={e => setItems(prev => { const n = [...prev]; n[i] = e.target.value; return n; })} placeholder={["Something smallâ€¦", "Someone who mattersâ€¦", "A moment todayâ€¦"][i]} className="flex-1 bg-white border border-stone-200 rounded-lg px-3 py-1.5 text-xs text-stone-700 focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-transparent placeholder:text-stone-300" />
        </div>
      ))}
      <div className="flex items-center justify-between">
        {filled === 3 ? <p className="text-xs text-emerald-600">Three good things. That's more than enough.</p> : <span />}
        {filled > 0 && <CopyButton getText={getText} />}
      </div>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Activity content router â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function ActivityContent({ activity }) {
  switch (activity.type) {
    case "breathe": return <div className="mt-2"><BreathingGuide running={true} /></div>;
    case "grounding": return <GroundingExercise />;
    case "minitimer": return <MiniTimer seconds={activity.timerSec} />;
    case "link": return <a href={activity.url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-1.5 mt-2 px-3 py-1.5 rounded-full bg-emerald-600 text-white text-xs hover:bg-emerald-700 active:scale-95 transition-all">{activity.linkLabel} â†’</a>;
    case "tip": return <p className="text-xs text-emerald-600 mt-2 italic">{activity.tip}</p>;
    case "braindump": return <BrainDump />;
    case "bodyscan": return <BodyScanGuide />;
    case "gratitude": return <GratitudeExercise />;
    default: return null;
  }
}

const timerPresets = [{ label: "1 min", seconds: 60 },{ label: "3 min", seconds: 180 },{ label: "5 min", seconds: 300 },{ label: "10 min", seconds: 600 }];
const moods = [{ emoji: "ðŸ˜«", label: "Worse" },{ emoji: "ðŸ˜", label: "Same" },{ emoji: "ðŸ™‚", label: "A little better" },{ emoji: "ðŸ˜Œ", label: "Calmer" },{ emoji: "âœ¨", label: "Refreshed" }];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Breathing guide â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function BreathingGuide({ running }) {
  const [phase, setPhase] = useState(0);
  const [tick, setTick] = useState(0);
  const phaseNames = ["Breathe in", "Hold", "Breathe out", "Hold"];
  const phaseDurations = [4, 4, 4, 4];
  const intervalRef = useRef(null);
  useEffect(() => {
    if (running) { intervalRef.current = setInterval(() => { setTick(t => { const next = t + 1; if (next >= phaseDurations[phase]) { setPhase(p => (p + 1) % 4); return 0; } return next; }); }, 1000); } else { clearInterval(intervalRef.current); }
    return () => clearInterval(intervalRef.current);
  }, [running, phase]);
  useEffect(() => { if (!running) { setPhase(0); setTick(0); } }, [running]);
  const scale = phase === 0 ? 0.6 + 0.4 * (tick / 4) : phase === 1 ? 1 : phase === 2 ? 1 - 0.4 * (tick / 4) : 0.6;
  const opacity = running ? 1 : 0.4;
  return (
    <div className="flex flex-col items-center" style={{ opacity, transition: "opacity 0.5s" }}>
      <div className="relative w-36 h-36 flex items-center justify-center">
        <div className="absolute rounded-full bg-emerald-200/30" style={{ width: "100%", height: "100%", transform: `scale(${scale * 1.15})`, transition: "transform 1s ease-in-out" }} />
        <div className="absolute rounded-full bg-gradient-to-br from-emerald-300 to-teal-400 shadow-lg shadow-emerald-200/50" style={{ width: "75%", height: "75%", transform: `scale(${scale})`, transition: "transform 1s ease-in-out" }} />
        <div className="relative z-10 text-center">
          <p className="text-sm font-medium text-white drop-shadow-sm">{running ? phaseNames[phase] : "Ready"}</p>
          {running && <p className="text-2xl font-light text-white/90 tabular-nums drop-shadow-sm">{phaseDurations[phase] - tick}</p>}
        </div>
      </div>
      <p className="text-xs text-stone-400 mt-3">{running ? "Follow the circle" : "Press start to begin guided breathing"}</p>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ambient blobs â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AmbientBackground() {
  return (
    <div className="fixed inset-0 pointer-events-none overflow-hidden" style={{ zIndex: 0 }}>
      <div className="absolute w-96 h-96 rounded-full opacity-20 bg-emerald-200 blur-3xl" style={{ top: "10%", left: "-10%", animation: "float1 20s ease-in-out infinite" }} />
      <div className="absolute w-80 h-80 rounded-full opacity-15 bg-teal-200 blur-3xl" style={{ top: "50%", right: "-5%", animation: "float2 25s ease-in-out infinite" }} />
      <div className="absolute w-64 h-64 rounded-full opacity-10 bg-cyan-200 blur-3xl" style={{ bottom: "5%", left: "30%", animation: "float3 18s ease-in-out infinite" }} />
      <style>{`
        @keyframes float1 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(40px, 30px); } }
        @keyframes float2 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(-30px, -40px); } }
        @keyframes float3 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(20px, -25px); } }
      `}</style>
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Take 5 page â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function TakeFive() {
  const [presetIndex, setPresetIndex] = useState(2);
  const total = timerPresets[presetIndex].seconds;
  const [seconds, setSeconds] = useState(total);
  const [running, setRunning] = useState(false);
  const [picked, setPicked] = useState(null);
  const [randomHighlight, setRandomHighlight] = useState(null);
  const [showMoodCheck, setShowMoodCheck] = useState(false);
  const [selectedMood, setSelectedMood] = useState(null);
  const [mode, setMode] = useState("timer");
  const intervalRef = useRef(null);

  useEffect(() => { if (running && seconds > 0) { intervalRef.current = setInterval(() => setSeconds(s => s - 1), 1000); } else { clearInterval(intervalRef.current); } return () => clearInterval(intervalRef.current); }, [running, seconds]);
  useEffect(() => { if (seconds === 0) { setRunning(false); setShowMoodCheck(true); } }, [seconds]);

  const mins = Math.floor(seconds / 60), secs = seconds % 60;
  const pct = ((total - seconds) / total) * 100;
  const reset = () => { setRunning(false); setSeconds(total); setShowMoodCheck(false); setSelectedMood(null); };
  const selectPreset = (i) => { setPresetIndex(i); setSeconds(timerPresets[i].seconds); setRunning(false); setShowMoodCheck(false); setSelectedMood(null); };
  const pickRandom = () => { let idx; do { idx = Math.floor(Math.random() * activities.length); } while (idx === randomHighlight); setRandomHighlight(idx); setPicked(idx); setTimeout(() => { const el = document.getElementById(`activity-${idx}`); if (el) el.scrollIntoView({ behavior: "smooth", block: "center" }); }, 100); };

  return (
    <>
      <AmbientBackground />
      <div className="w-full max-w-lg mx-auto relative z-10">
        <div className="text-center mb-6">
          <div className="inline-flex items-center gap-2 bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full text-xs font-medium mb-3"><Icons.wind size={14} /> Take a break</div>
          <h2 className="text-xl font-semibold text-stone-800">Take 5</h2>
          <p className="text-stone-400 text-sm mt-1">Step away from the noise for a few minutes.</p>
        </div>

        <div className="flex justify-center mb-6">
          <div className="inline-flex bg-stone-100 rounded-full p-1 gap-1">
            <button onClick={() => setMode("timer")} className={`px-4 py-1.5 rounded-full text-sm font-medium transition-all ${mode === "timer" ? "bg-white text-stone-800 shadow-sm" : "text-stone-400 hover:text-stone-600"}`}>Timer</button>
            <button onClick={() => setMode("breathe")} className={`px-4 py-1.5 rounded-full text-sm font-medium transition-all ${mode === "breathe" ? "bg-white text-stone-800 shadow-sm" : "text-stone-400 hover:text-stone-600"}`}>Guided Breathing</button>
          </div>
        </div>

        {mode === "breathe" ? (
          <div className="bg-white/80 backdrop-blur-sm rounded-2xl border border-stone-200 p-8 shadow-sm mb-6">
            <BreathingGuide running={running} />
            <div className="flex items-center justify-center gap-3 mt-6">
              <button onClick={() => setRunning(!running)} className="flex items-center gap-2 px-6 py-2.5 rounded-full bg-stone-800 text-white text-sm hover:bg-stone-700 active:scale-95 transition-all">
                {running ? <><Icons.pause size={16} /> Pause</> : <><Icons.play size={16} /> Start</>}
              </button>
            </div>
            <p className="text-center text-xs text-stone-400 mt-3">4-4-4-4 box breathing pattern</p>
          </div>
        ) : (
          <>
            <div className="flex justify-center gap-2 mb-4">
              {timerPresets.map((p, i) => (
                <button key={p.label} onClick={() => selectPreset(i)} className={`px-4 py-1.5 rounded-full text-sm font-medium transition-all border ${i === presetIndex ? "bg-emerald-50 border-emerald-200 text-emerald-700" : "bg-white border-stone-200 text-stone-400 hover:text-stone-600 hover:border-stone-300"}`}>{p.label}</button>
              ))}
            </div>
            <div className="bg-white/80 backdrop-blur-sm rounded-2xl border border-stone-200 p-8 shadow-sm mb-6">
              {!showMoodCheck ? (
                <>
                  <div className="relative flex items-center justify-center mb-6">
                    <svg width="180" height="180" className="-rotate-90">
                      <circle cx="90" cy="90" r="78" fill="none" stroke="#f5f5f4" strokeWidth="6" />
                      <circle cx="90" cy="90" r="78" fill="none" stroke={seconds === 0 ? "#a3e635" : "#34d399"} strokeWidth="6" strokeLinecap="round" strokeDasharray={2 * Math.PI * 78} strokeDashoffset={2 * Math.PI * 78 * (1 - pct / 100)} className="transition-all duration-1000 ease-linear" />
                    </svg>
                    <div className="absolute flex flex-col items-center">
                      <span className="text-4xl font-light text-stone-800 tabular-nums tracking-tight">{String(mins).padStart(2, "0")}:{String(secs).padStart(2, "0")}</span>
                      <span className="text-xs text-stone-400 mt-1">{running ? "Breatheâ€¦" : "Ready when you are"}</span>
                    </div>
                  </div>
                  <div className="flex items-center justify-center gap-3">
                    <button onClick={() => setRunning(!running)} className="flex items-center gap-2 px-6 py-2.5 rounded-full bg-stone-800 text-white text-sm hover:bg-stone-700 active:scale-95 transition-all">
                      {running ? <><Icons.pause size={16} /> Pause</> : <><Icons.play size={16} /> {seconds < total ? "Resume" : "Start"}</>}
                    </button>
                    {seconds < total && <button onClick={reset} className="p-2.5 rounded-full border border-stone-200 text-stone-400 hover:bg-stone-50 transition-colors"><Icons.refresh size={16} /></button>}
                  </div>
                </>
              ) : (
                <div className="text-center">
                  <div className="mb-1"><span className="text-3xl">ðŸŽ‰</span></div>
                  <p className="text-lg font-semibold text-stone-800 mb-1">Time's up â€” nice work</p>
                  <p className="text-sm text-stone-400 mb-5">How are you feeling now?</p>
                  <div className="flex justify-center gap-2 flex-wrap mb-5">
                    {moods.map((m, i) => (
                      <button key={i} onClick={() => setSelectedMood(i)} className={`flex flex-col items-center gap-1 px-3 py-2.5 rounded-xl border transition-all ${selectedMood === i ? "bg-emerald-50 border-emerald-300 shadow-sm scale-105" : "bg-stone-50 border-stone-200 hover:border-stone-300"}`}>
                        <span className="text-2xl">{m.emoji}</span>
                        <span className={`text-xs font-medium ${selectedMood === i ? "text-emerald-700" : "text-stone-500"}`}>{m.label}</span>
                      </button>
                    ))}
                  </div>
                  {selectedMood !== null && <p className="text-sm text-emerald-600 mb-4">{selectedMood >= 3 ? "Glad you're feeling better!" : selectedMood >= 1 ? "Every break counts." : "Be gentle with yourself. Try another round?"}</p>}
                  <button onClick={reset} className="flex items-center gap-2 mx-auto text-sm text-stone-400 hover:text-stone-600 transition-colors"><Icons.refresh size={14} /> Go again</button>
                </div>
              )}
            </div>
          </>
        )}

        <div className="flex items-center justify-between mb-3 px-1">
          <p className="text-xs font-medium uppercase tracking-wide text-stone-400">Clear your mind</p>
          <button onClick={pickRandom} className="flex items-center gap-1.5 text-xs font-medium text-emerald-600 hover:text-emerald-700 transition-colors px-2.5 py-1 rounded-full bg-emerald-50 hover:bg-emerald-100"><Icons.sparkle size={10} /> Pick for me</button>
        </div>
        <div className="grid grid-cols-2 gap-2.5">
          {activities.map((act, i) => {
            const isOpen = picked === i;
            return (
              <div id={`activity-${i}`} key={i} className={`rounded-xl border transition-all duration-300 ${isOpen ? "bg-emerald-50 border-emerald-200 shadow-sm col-span-2" : "bg-white/80 backdrop-blur-sm border-stone-200 hover:border-stone-300 hover:shadow-sm"} ${randomHighlight === i && isOpen ? "ring-2 ring-emerald-300 ring-offset-2" : ""}`}>
                <button onClick={() => setPicked(isOpen ? null : i)} className="w-full text-left p-3.5">
                  <div className="flex items-start gap-3">
                    <span className="text-xl flex-shrink-0">{act.emoji}</span>
                    <div className="flex-1 min-w-0">
                      <p className={`text-sm font-medium leading-snug ${isOpen ? "text-emerald-800" : "text-stone-700"}`}>{act.title}</p>
                      <p className={`text-xs mt-0.5 leading-relaxed ${isOpen ? "text-emerald-600" : "text-stone-400"}`}>{act.desc}</p>
                    </div>
                  </div>
                </button>
                {isOpen && <div className="px-3.5 pb-3.5 pl-12"><ActivityContent activity={act} /></div>}
              </div>
            );
          })}
        </div>
      </div>
    </>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Five Whys page â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function FiveWhys() {
  const TOTAL_STEPS = layerPrompts.length;
  const [answers, setAnswers] = useState([""]);
  const [currentStep, setCurrentStep] = useState(0);
  const [done, setDone] = useState(false);
  const [copied, setCopied] = useState(false);

  const handleSubmit = () => { if (currentStep < TOTAL_STEPS - 1) { setAnswers(prev => [...prev, ""]); setCurrentStep(s => s + 1); } else { setDone(true); } };
  const handleChange = (val) => { setAnswers(prev => { const next = [...prev]; next[currentStep] = val; return next; }); };
  const getJSON = () => JSON.stringify({ date: new Date().toISOString(), session: answers.filter((a, i) => i <= currentStep && a.trim()).map((a, i) => ({ level: i, prompt: layerPrompts[i], response: a.trim() })) }, null, 2);
  const downloadJSON = () => { const blob = new Blob([getJSON()], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `five-whys-${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); };
  const copyJSON = () => { navigator.clipboard.writeText(getJSON()); setCopied(true); setTimeout(() => setCopied(false), 2000); };
  const reset = () => { setAnswers([""]); setCurrentStep(0); setDone(false); setCopied(false); };

  return (
    <div className="w-full max-w-lg mx-auto">
      <div className="text-center mb-8">
        <div className="inline-flex items-center gap-2 bg-amber-50 text-amber-600 px-3 py-1 rounded-full text-xs font-medium mb-3"><Icons.layers size={14} /> Self-inquiry</div>
        <h2 className="text-xl font-semibold text-stone-800">5 Whys</h2>
        <p className="text-stone-400 text-sm mt-1">Start at the surface. Dig to the root.</p>
      </div>
      <div className="flex gap-1.5 mb-8 px-1">
        {Array.from({ length: TOTAL_STEPS }).map((_, i) => <div key={i} className={`h-1 flex-1 rounded-full transition-all duration-500 ${i <= currentStep ? (done ? "bg-amber-400" : "bg-amber-300") : "bg-stone-200"}`} />)}
      </div>
      <div>
        {answers.map((answer, i) => (
          <Step key={i} index={i} prompt={layerPrompts[i]} prevAnswer={i > 0 ? answers[i - 1] : null} answer={i < currentStep ? answer : i === currentStep ? answer : undefined} active={i === currentStep && !done} done={done} onSubmit={handleSubmit} onChange={handleChange} total={TOTAL_STEPS} />
        ))}
      </div>
      {done && (
        <div className="mt-8">
          <div className="rounded-2xl border border-stone-200 bg-white p-5 shadow-sm">
            <div className="flex items-center gap-2 mb-3"><Icons.sparkle size={14} className="text-amber-500" /><span className="text-sm font-medium text-stone-700">Your session</span></div>
            <pre className="bg-stone-50 rounded-xl p-4 text-xs text-stone-500 overflow-x-auto max-h-52 overflow-y-auto leading-relaxed border border-stone-100">{getJSON()}</pre>
            <div className="flex gap-2 mt-4">
              <button onClick={downloadJSON} className="flex items-center gap-2 flex-1 justify-center px-4 py-2.5 rounded-xl bg-stone-800 text-white text-sm hover:bg-stone-700 active:scale-95 transition-all"><Icons.download size={14} /> Download JSON</button>
              <button onClick={copyJSON} className="flex items-center gap-2 flex-1 justify-center px-4 py-2.5 rounded-xl border border-stone-200 text-stone-600 text-sm hover:bg-stone-50 active:scale-95 transition-all">{copied ? <><Icons.check size={14} className="text-emerald-500" /> Copied!</> : <><Icons.copy size={14} /> Copy</>}</button>
            </div>
          </div>
          <div className="flex justify-center mt-5"><button onClick={reset} className="flex items-center gap-2 text-sm text-stone-400 hover:text-stone-600 transition-colors"><Icons.refresh size={14} /> Start a new session</button></div>
        </div>
      )}
    </div>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Dopamine modes â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const dopamineModes = [
  { id: "confetti", emoji: "ðŸŽ‰", label: "Confetti", desc: "Classic cannon", btnGrad: "from-violet-500 to-fuchsia-500", shadow: "shadow-violet-200 hover:shadow-violet-300", accent: "violet", colors: ["#f59e0b","#ef4444","#8b5cf6","#3b82f6","#10b981","#ec4899","#f97316","#06b6d4"], shapes: ["rect","circle"], gravity: 0.15, count: 70, speedMin: 3, speedMax: 9, sizeMin: 4, sizeMax: 7 },
  { id: "stars", emoji: "âœ¨", label: "Starfield", desc: "Golden shower of stars", btnGrad: "from-amber-400 to-yellow-500", shadow: "shadow-amber-200 hover:shadow-amber-300", accent: "amber", colors: ["#fbbf24","#f59e0b","#fcd34d","#fde68a","#fff7ed","#fffbeb"], shapes: ["star"], gravity: 0.06, count: 50, speedMin: 2, speedMax: 7, sizeMin: 5, sizeMax: 10 },
  { id: "bubbles", emoji: "ðŸ«§", label: "Bubbles", desc: "Floaty & dreamy", btnGrad: "from-sky-400 to-cyan-400", shadow: "shadow-sky-200 hover:shadow-sky-300", accent: "sky", colors: ["#7dd3fc","#38bdf8","#0ea5e9","#bae6fd","#e0f2fe","#a5f3fc","#67e8f9"], shapes: ["bubble"], gravity: -0.03, count: 35, speedMin: 1, speedMax: 4, sizeMin: 8, sizeMax: 20 },
  { id: "fire", emoji: "ðŸ”¥", label: "Fireball", desc: "Explosive energy", btnGrad: "from-orange-500 to-red-600", shadow: "shadow-orange-200 hover:shadow-orange-300", accent: "orange", colors: ["#ef4444","#f97316","#fb923c","#fbbf24","#fde68a","#dc2626","#ff6b35"], shapes: ["rect","circle","rect"], gravity: 0.12, count: 90, speedMin: 4, speedMax: 12, sizeMin: 3, sizeMax: 8 },
  { id: "hearts", emoji: "ðŸ’–", label: "Love Bomb", desc: "Spread the love", btnGrad: "from-pink-500 to-rose-500", shadow: "shadow-pink-200 hover:shadow-pink-300", accent: "pink", colors: ["#ec4899","#f472b6","#fb7185","#fda4af","#fecdd3","#be185d"], shapes: ["heart"], gravity: 0.08, count: 45, speedMin: 2, speedMax: 7, sizeMin: 6, sizeMax: 12 },
];

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Dopamine page â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function DopamineHitPage() {
  const canvasRef = useRef(null);
  const particlesRef = useRef([]);
  const animRef = useRef(null);
  const [score, setScore] = useState(0);
  const [best, setBest] = useState(0);
  const [combo, setCombo] = useState(0);
  const [lastClick, setLastClick] = useState(0);
  const [flash, setFlash] = useState(false);
  const [modeIndex, setModeIndex] = useState(0);
  const mode = dopamineModes[modeIndex];

  const drawParticle = useCallback((ctx, p) => {
    ctx.save(); ctx.globalAlpha = Math.max(0, p.life); ctx.translate(p.x, p.y); ctx.rotate((p.rotation * Math.PI) / 180); ctx.fillStyle = p.color;
    if (p.shape === "star") { const s = p.size; ctx.beginPath(); for (let i = 0; i < 5; i++) { const ang = (i * 4 * Math.PI) / 5 - Math.PI / 2; i === 0 ? ctx.moveTo(Math.cos(ang) * s, Math.sin(ang) * s) : ctx.lineTo(Math.cos(ang) * s, Math.sin(ang) * s); } ctx.closePath(); ctx.fill(); }
    else if (p.shape === "heart") { const s = p.size * 0.5; ctx.beginPath(); ctx.moveTo(0, s * 0.4); ctx.bezierCurveTo(-s, -s * 0.5, -s * 2, s * 0.4, 0, s * 1.6); ctx.bezierCurveTo(s * 2, s * 0.4, s, -s * 0.5, 0, s * 0.4); ctx.fill(); }
    else if (p.shape === "bubble") { const s = p.size; ctx.beginPath(); ctx.arc(0, 0, s, 0, Math.PI * 2); ctx.strokeStyle = p.color; ctx.lineWidth = 1.5; ctx.globalAlpha = Math.max(0, p.life * 0.6); ctx.stroke(); ctx.globalAlpha = Math.max(0, p.life * 0.15); ctx.fill(); ctx.beginPath(); ctx.arc(-s * 0.3, -s * 0.3, s * 0.25, 0, Math.PI * 2); ctx.globalAlpha = Math.max(0, p.life * 0.5); ctx.fillStyle = "#fff"; ctx.fill(); }
    else if (p.shape === "rect") { ctx.fillRect(-p.size / 2, -p.size / 4, p.size, p.size / 2); }
    else { ctx.beginPath(); ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2); ctx.fill(); }
    ctx.restore();
  }, []);

  const spawnParticles = useCallback((cx, cy) => {
    const m = dopamineModes[modeIndex]; const count = m.count + Math.floor(Math.random() * 30);
    for (let i = 0; i < count; i++) { const angle = Math.random() * Math.PI * 2; const speed = m.speedMin + Math.random() * (m.speedMax - m.speedMin);
      particlesRef.current.push({ x: cx, y: cy, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed - 3, size: m.sizeMin + Math.random() * (m.sizeMax - m.sizeMin), color: m.colors[Math.floor(Math.random() * m.colors.length)], rotation: Math.random() * 360, rotSpeed: (Math.random() - 0.5) * 12, life: 1, decay: 0.006 + Math.random() * 0.008, shape: m.shapes[Math.floor(Math.random() * m.shapes.length)], gravity: m.gravity });
    }
  }, [modeIndex]);

  useEffect(() => {
    const canvas = canvasRef.current; if (!canvas) return; const ctx = canvas.getContext("2d"); let dpr = 2;
    const resize = () => { const w = window.innerWidth, h = window.innerHeight; canvas.width = w * dpr; canvas.height = h * dpr; canvas.style.width = w + "px"; canvas.style.height = h + "px"; ctx.setTransform(dpr, 0, 0, dpr, 0, 0); };
    resize(); window.addEventListener("resize", resize);
    const animate = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); particlesRef.current = particlesRef.current.filter(p => p.life > 0); for (const p of particlesRef.current) { p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.vx *= 0.99; p.rotation += p.rotSpeed; p.life -= p.decay; drawParticle(ctx, p); } animRef.current = requestAnimationFrame(animate); };
    animate(); return () => { cancelAnimationFrame(animRef.current); window.removeEventListener("resize", resize); };
  }, [drawParticle]);

  const handleFire = () => {
    const now = Date.now(); const newCombo = now - lastClick < 800 ? combo + 1 : 0; setCombo(newCombo); setLastClick(now);
    const multiplier = 1 + Math.min(newCombo, 10); const points = 10 * multiplier;
    setScore(s => { const next = s + points; setBest(b => Math.max(b, next)); return next; });
    setFlash(true); setTimeout(() => setFlash(false), 150);
    const w = window.innerWidth, h = window.innerHeight, cx = w / 2 + (Math.random() - 0.5) * 120, cy = h * 0.5;
    spawnParticles(cx, cy);
    if (newCombo >= 3) spawnParticles(Math.random() * w, Math.random() * h * 0.7);
    if (newCombo >= 6) { spawnParticles(Math.random() * w, Math.random() * h * 0.5); spawnParticles(Math.random() * w, Math.random() * h * 0.5); }
    if (newCombo >= 10) { for (let i = 0; i < 3; i++) spawnParticles(Math.random() * w, Math.random() * h * 0.6); }
  };

  const milestones = [100, 500, 1000, 2500, 5000, 10000, 25000, 50000];
  const nextMilestone = milestones.find(m => m > score) || score + 10000;
  const prevMilestone = milestones.filter(m => m <= score).pop() || 0;
  const progressPct = ((score - prevMilestone) / (nextMilestone - prevMilestone)) * 100;
  const accentMap = { violet: ["bg-violet-100","text-violet-700","from-violet-400","to-fuchsia-400"], amber: ["bg-amber-100","text-amber-700","from-amber-400","to-yellow-400"], sky: ["bg-sky-100","text-sky-700","from-sky-400","to-cyan-400"], orange: ["bg-orange-100","text-orange-700","from-orange-400","to-red-400"], pink: ["bg-pink-100","text-pink-700","from-pink-400","to-rose-400"] };
  const [comboBg, comboText, gradFrom, gradTo] = accentMap[mode.accent] || accentMap.violet;

  return (
    <>
      <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none" style={{ zIndex: 40 }} />
      <div className="w-full max-w-lg mx-auto relative z-30">
        <div className="text-center mb-6">
          <div className="inline-flex items-center gap-2 bg-violet-50 text-violet-600 px-3 py-1 rounded-full text-xs font-medium mb-3"><Icons.party size={14} /> Dopamine hit</div>
          <h2 className="text-xl font-semibold text-stone-800">{mode.label}</h2>
          <p className="text-stone-400 text-sm mt-1">{mode.desc}</p>
        </div>
        <div className="flex gap-2 justify-center mb-6 flex-wrap">
          {dopamineModes.map((m, i) => <button key={m.id} onClick={() => setModeIndex(i)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-all border ${i === modeIndex ? "bg-white border-stone-300 text-stone-800 shadow-sm" : "bg-white/50 border-stone-200 text-stone-400 hover:text-stone-600 hover:border-stone-300"}`}><span>{m.emoji}</span> {m.label}</button>)}
        </div>
        <div className={`bg-white rounded-2xl border p-4 shadow-sm mb-6 transition-all duration-150 ${flash ? "border-stone-300 shadow-md" : "border-stone-200"}`}>
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-3">
              <div><p className="text-2xl font-bold text-stone-800 tabular-nums">{score.toLocaleString()}</p><p className="text-xs text-stone-400">points</p></div>
              {combo > 1 && <span className={`px-2.5 py-1 rounded-full ${comboBg} ${comboText} text-xs font-bold animate-bounce`}>{combo}x combo!</span>}
            </div>
            <div className="text-right"><p className="text-sm font-medium text-stone-500 tabular-nums">{best.toLocaleString()}</p><p className="text-xs text-stone-400">best</p></div>
          </div>
          <div className="h-1.5 bg-stone-100 rounded-full overflow-hidden"><div className={`h-full bg-gradient-to-r ${gradFrom} ${gradTo} rounded-full transition-all duration-300`} style={{ width: `${Math.min(100, progressPct)}%` }} /></div>
          <p className="text-xs text-stone-400 mt-1.5 text-right">next milestone: {nextMilestone.toLocaleString()}</p>
        </div>
        <div className="flex flex-col items-center mb-6">
          <button onClick={handleFire} className={`group relative w-32 h-32 rounded-full bg-gradient-to-br ${mode.btnGrad} text-white shadow-lg ${mode.shadow} active:scale-90 transition-all duration-150 flex items-center justify-center`}>
            <span className="text-5xl group-active:scale-125 transition-transform select-none">{mode.emoji}</span>
            <div className="absolute -inset-3 rounded-full border-2 border-white/20 animate-ping pointer-events-none" style={{ animationDuration: "2s" }} />
          </button>
          <p className="mt-4 text-sm text-stone-400">{combo >= 10 ? "UNSTOPPABLE" : combo >= 6 ? "On fire!!" : combo >= 3 ? "Keep going!" : "Smash it."}</p>
        </div>
        <div className="flex justify-center"><button onClick={() => { setScore(0); setCombo(0); }} className="flex items-center gap-2 text-sm text-stone-400 hover:text-stone-600 transition-colors"><Icons.refresh size={14} /> Reset score</button></div>
      </div>
    </>
  );
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ main app â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function App() {
  const [tab, setTab] = useState("whys");
  return (
    <div className="min-h-screen bg-gradient-to-b from-stone-50 to-stone-100">
      <nav className="sticky top-0 z-50 backdrop-blur-xl bg-white/70 border-b border-stone-200/50">
        <div className="max-w-lg mx-auto px-4 flex items-center h-14 gap-1">
          <span className="text-base font-semibold text-stone-800 mr-auto tracking-tight">Mindpeel</span>
          <button onClick={() => setTab("whys")} className={`flex items-center gap-1.5 px-4 py-1.5 rounded-full text-sm font-medium transition-all ${tab === "whys" ? "bg-amber-100 text-amber-800" : "text-stone-400 hover:text-stone-600 hover:bg-stone-100"}`}><Icons.layers size={14} /> 5 Whys</button>
          <button onClick={() => setTab("take5")} className={`flex items-center gap-1.5 px-4 py-1.5 rounded-full text-sm font-medium transition-all ${tab === "take5" ? "bg-emerald-100 text-emerald-800" : "text-stone-400 hover:text-stone-600 hover:bg-stone-100"}`}><Icons.wind size={14} /> Take 5</button>
          <button onClick={() => setTab("confetti")} className={`flex items-center gap-1.5 px-4 py-1.5 rounded-full text-sm font-medium transition-all ${tab === "confetti" ? "bg-violet-100 text-violet-800" : "text-stone-400 hover:text-stone-600 hover:bg-stone-100"}`}><Icons.party size={14} /> Dopamine</button>
        </div>
      </nav>
      <main className="px-4 py-10 pb-20">
        {tab === "whys" ? <FiveWhys /> : tab === "take5" ? <TakeFive /> : <DopamineHitPage />}
      </main>
      <div className="fixed bottom-0 left-0 right-0 z-50 border-t border-stone-200/50 bg-white/80 backdrop-blur-xl">
        <div className="max-w-lg mx-auto px-4 py-2.5 text-center">
          <p className="text-xs text-stone-400 leading-relaxed">
            Mindpeel runs entirely in your browser. No data is collected, stored, or sent anywhere. Everything you type stays on your device and disappears when you close the page.
          </p>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>